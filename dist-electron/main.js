"use strict";var x=Object.create;var E=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var j=(o,e,t)=>e in o?E(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var N=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of T(e))!z.call(o,s)&&s!==t&&E(o,s,{get:()=>e[s],enumerable:!(n=q(e,s))||n.enumerable});return o};var y=(o,e,t)=>(t=o!=null?x(J(o)):{},N(e||!o||!o.__esModule?E(t,"default",{value:o,enumerable:!0}):t,o));var l=(o,e,t)=>j(o,typeof e!="symbol"?e+"":e,t);const c=require("electron"),m=require("path"),I=require("fs"),P=require("whatsapp-web.js"),Q=require("qrcode-terminal");function H(o){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const t in o)if(t!=="default"){const n=Object.getOwnPropertyDescriptor(o,t);Object.defineProperty(e,t,n.get?n:{enumerable:!0,get:()=>o[t]})}}return e.default=o,Object.freeze(e)}const O=H(Q);class D{constructor(e){l(this,"client",null);l(this,"mainWindow",null);l(this,"status","disconnected");l(this,"messageReceiverWorker",null);this.mainWindow=e,this.initializeClient()}setMessageReceiverWorker(e){this.messageReceiverWorker=e}getChromiumExecutablePath(){if(!c.app.isPackaged)return;const e=m.join(process.resourcesPath,"app.asar.unpacked","node_modules","whatsapp-web.js","node_modules","puppeteer-core",".local-chromium","win64-1045629","chrome-win","chrome.exe");if(console.log("[WhatsAppManager] Checking Chromium path:",e),I.existsSync(e))return console.log("[WhatsAppManager] Chromium found at:",e),e;console.error("[WhatsAppManager] Chromium not found at expected path:",e)}initializeClient(){try{console.log("[WhatsAppManager] Initializing client...");const e=this.getChromiumExecutablePath(),t={headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--disable-gpu"]};e&&(t.executablePath=e),console.log("[WhatsAppManager] Puppeteer config:",JSON.stringify(t,null,2)),this.client=new P.Client({authStrategy:new P.LocalAuth({dataPath:c.app.isPackaged?m.join(c.app.getPath("userData"),".wwebjs_auth"):".wwebjs_auth"}),puppeteer:t}),this.setupEventHandlers()}catch(e){console.error("[WhatsAppManager] Error initializing client:",e),this.status="disconnected",this.broadcastStatus("disconnected")}}setupEventHandlers(){this.client&&(this.client.on("qr",e=>{console.log("[WhatsAppManager] QR Code received"),O.generate(e,{small:!0}),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:qr-code",e),this.status="connecting",this.broadcastStatus("connecting")}),this.client.on("ready",()=>{console.log("[WhatsAppManager] Client is ready!"),this.status="ready",this.broadcastStatus("ready")}),this.client.on("authenticated",()=>{console.log("[WhatsAppManager] Client authenticated")}),this.client.on("auth_failure",e=>{console.error("[WhatsAppManager] Authentication failed:",e),this.status="disconnected",this.broadcastStatus("disconnected"),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:error",{type:"auth_failure",message:"Authentication failed. Please try again."})}),this.client.on("disconnected",e=>{console.log("[WhatsAppManager] Client disconnected:",e),this.status="disconnected",this.broadcastStatus("disconnected")}),this.client.on("loading_screen",(e,t)=>{console.log(`[WhatsAppManager] Loading... ${e}% - ${t}`)}),this.client.on("message",async e=>{console.log("[WhatsAppManager] Message received:",e.from),this.messageReceiverWorker?await this.messageReceiverWorker.handleIncomingMessage(e):this.mainWindow&&this.mainWindow.webContents.send("whatsapp:message-received",{id:e.id._serialized,from:e.from,to:e.to,body:e.body,type:e.type,timestamp:e.timestamp,hasMedia:e.hasMedia})}))}async connect(){try{if(console.log("[WhatsAppManager] Connecting..."),!this.client)throw new Error("Client not initialized");return this.status==="ready"?(console.log("[WhatsAppManager] Already connected"),!0):(this.status="connecting",this.broadcastStatus("connecting"),await this.client.initialize(),!0)}catch(e){throw console.error("[WhatsAppManager] Connection error:",e),this.status="disconnected",this.broadcastStatus("disconnected"),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:error",{type:"connection_error",message:e instanceof Error?e.message:"Unknown connection error"}),e}}async disconnect(){try{console.log("[WhatsAppManager] Disconnecting..."),this.client&&(await this.client.destroy(),this.client=null),this.status="disconnected",this.broadcastStatus("disconnected"),this.initializeClient()}catch(e){throw console.error("[WhatsAppManager] Disconnect error:",e),this.status="disconnected",this.broadcastStatus("disconnected"),e}}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return t.startsWith("0")&&(t="62"+t.slice(1)),t.endsWith("@c.us")||(t+="@c.us"),t}async downloadFile(e){const t=await import("https"),n=await import("http"),s=await import("fs"),r=await import("path"),i=await import("os");return new Promise((a,d)=>{try{const h=i.tmpdir(),p=`whatsapp_media_${Date.now()}_${r.basename(e).split("?")[0]}`,f=r.join(h,p);console.log(`[WhatsAppManager] Downloading to: ${f}`);const U=e.startsWith("https://")?t:n,b=s.createWriteStream(f);U.get(e,W=>{if(W.statusCode!==200){d(new Error(`Failed to download file: HTTP ${W.statusCode}`));return}W.pipe(b),b.on("finish",()=>{b.close(),console.log(`[WhatsAppManager] Download complete: ${f}`),a(f)}),b.on("error",L=>{s.unlink(f,()=>{}),d(L)})}).on("error",W=>{s.unlink(f,()=>{}),d(W)})}catch(h){d(h)}})}async sendMessage(e,t){try{if(!this.client||this.status!=="ready")throw new Error("WhatsApp client is not ready");const n=this.formatPhoneNumber(e);return console.log(`[WhatsAppManager] Sending message to ${e} (formatted: ${n})`),await this.client.sendMessage(n,t),console.log(`[WhatsAppManager] Message sent successfully to ${e}`),!0}catch(n){throw console.error("[WhatsAppManager] Send message error:",n),n}}async sendMessageWithMedia(e,t,n){let s=null;try{if(!this.client||this.status!=="ready")throw new Error("WhatsApp client is not ready");const r=this.formatPhoneNumber(e);console.log(`[WhatsAppManager] Sending media message to ${e} (formatted: ${r})`);let i;return n.startsWith("http://")||n.startsWith("https://")?(console.log(`[WhatsAppManager] Downloading remote file: ${n}`),s=await this.downloadFile(n),i=P.MessageMedia.fromFilePath(s)):i=P.MessageMedia.fromFilePath(n),await this.client.sendMessage(r,i,{caption:t}),console.log(`[WhatsAppManager] Media message sent successfully to ${e}`),!0}catch(r){throw console.error("[WhatsAppManager] Send media message error:",r),r}finally{if(s)try{(await import("fs")).unlinkSync(s),console.log(`[WhatsAppManager] Cleaned up temp file: ${s}`)}catch(r){console.warn(`[WhatsAppManager] Failed to clean up temp file: ${s}`,r)}}}getStatus(){return this.status}isReady(){return this.status==="ready"&&this.client!==null}broadcastStatus(e){this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:status-change",e)}async getClientInfo(){try{if(!this.client||this.status!=="ready")return null;const e=this.client.info;return{wid:e.wid._serialized,pushname:e.pushname,platform:e.platform}}catch(e){return console.error("[WhatsAppManager] Get client info error:",e),null}}}class F{constructor(e,t){l(this,"whatsappManager");l(this,"mainWindow");l(this,"isProcessing",!1);l(this,"isPaused",!1);l(this,"currentJob",null);this.whatsappManager=e,this.mainWindow=t}getCurrentJob(){return this.currentJob}async processJob(e){var i;if(this.isProcessing)throw new Error("Already processing a job");this.isProcessing=!0,this.currentJob=e,this.isPaused=!1,console.log(`[MessageProcessor] Starting job ${e.jobId} with ${e.contacts.length} contacts`);let t=0,n=0,s=0;const r=[];this.reportProgress(e.jobId,t,e.contacts.length,n,s,"processing");for(const a of e.contacts){if(this.isPaused&&(this.reportProgress(e.jobId,t,e.contacts.length,n,s,"paused"),await this.waitForResume(),this.reportProgress(e.jobId,t,e.contacts.length,n,s,"processing")),!this.isProcessing)break;try{let h=e.template.content||"";if(e.template.variants&&e.template.variants.length>0){const f=Math.floor(Math.random()*e.template.variants.length);h=e.template.variants[f]}const p=this.formatMessage(h,a);console.log(`[MessageProcessor] Template has ${((i=e.template.variants)==null?void 0:i.length)||0} variants`),console.log(`[MessageProcessor] Selected template content: "${h}"`),console.log(`[MessageProcessor] Formatted message: "${p}"`),console.log(`[MessageProcessor] Has assets: ${e.assets&&e.assets.length>0}`),e.assets&&e.assets.length>0?await this.whatsappManager.sendMessageWithMedia(a.phone,p,e.assets[0]):await this.whatsappManager.sendMessage(a.phone,p),r.push({id:crypto.randomUUID(),activity_log_id:e.jobId,contact_id:a.id||"",contact_name:a.name||a.contact_name||"Unknown Contact",contact_phone:a.phone||a.contact_phone||"Unknown Phone",status:"sent",sent_at:new Date().toISOString()}),n++}catch(h){console.error(`[MessageProcessor] Failed to send to ${a.phone}:`,h),r.push({id:crypto.randomUUID(),activity_log_id:e.jobId,contact_id:a.id||"",contact_name:a.name||a.contact_name||"Unknown Contact",contact_phone:a.phone||a.contact_phone||"Unknown Phone",status:"failed",sent_at:new Date().toISOString(),error_message:h instanceof Error?h.message:String(h)}),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:job-error-detail",{jobId:e.jobId,phone:a.phone,error:h instanceof Error?h.message:String(h)}),s++}t++,this.reportProgress(e.jobId,t,e.contacts.length,n,s,"processing");const d=this.calculateDelayFromConfig(e.delayConfig);await this.delay(d)}this.isProcessing=!1,this.currentJob=null,this.reportProgress(e.jobId,t,e.contacts.length,n,s,"completed",{logs:r}),console.log(`[MessageProcessor] Job ${e.jobId} completed`)}pause(){return this.isProcessing&&!this.isPaused?(this.isPaused=!0,console.log("[MessageProcessor] Job paused"),!0):!1}resume(){return this.isProcessing&&this.isPaused?(this.isPaused=!1,console.log("[MessageProcessor] Job resumed"),!0):!1}stop(){return this.isProcessing?(this.isProcessing=!1,this.isPaused=!1,this.currentJob=null,console.log("[MessageProcessor] Job stopped"),!0):!1}formatMessage(e,t){let n=e;n=n.replace(/{{name}}/g,t.name||""),n=n.replace(/{{phone}}/g,t.phone||"");const s=n.match(/{{(.*?)}}/g);return s&&s.forEach(r=>{const i=r.replace(/{{|}}/g,"");t[i]!==void 0&&(n=n.replace(new RegExp(r,"g"),String(t[i])))}),n}reportProgress(e,t,n,s,r,i,a){this.mainWindow&&this.mainWindow.webContents.send("whatsapp:job-progress",{jobId:e,processed:t,total:n,success:s,failed:r,status:i,metadata:a})}calculateDelayFromConfig(e){if(!e||!e.delayRange||e.delayRange.length===0)return console.warn("[MessageProcessor] No valid delayConfig provided, using default values"),2e3+Math.random()*3e3;if(e.delayRange.length<1)return console.warn("[MessageProcessor] Invalid delayRange, using default values"),2e3+Math.random()*3e3;const s=e.delayRange[0]*1e3;let r=s;return e.mode==="dynamic"&&e.delayRange.length>=2?(r=e.delayRange[1]*1e3,r<=s?(console.warn("[MessageProcessor] Invalid delay range (max <= min), using static mode"),s):s+Math.random()*(r-s)):s}delay(e){return new Promise(t=>setTimeout(t,e))}waitForResume(){return new Promise(e=>{const t=setInterval(()=>{this.isPaused||(clearInterval(t),e())},500)})}}class ${constructor(e){l(this,"queue",[]);l(this,"isRunning",!1);l(this,"messageProcessor");this.messageProcessor=e}async addToQueue(e){console.log(`[QueueWorker] Adding job ${e.jobId} to queue`),this.queue.push(e),this.processQueue()}async processQueue(){if(!this.isRunning){for(this.isRunning=!0,console.log("[QueueWorker] Starting queue processing");this.queue.length>0;){const e=this.queue.shift();if(e)try{console.log(`[QueueWorker] Processing job ${e.jobId}`),await this.messageProcessor.processJob(e)}catch(t){console.error(`[QueueWorker] Error processing job ${e.jobId}:`,t)}}this.isRunning=!1,console.log("[QueueWorker] Queue processing finished")}}getQueueLength(){return this.queue.length}}let u=null,w=null,_=null;const V=(o,e,t,n)=>{console.log("[IPC] Setting up IPC handlers..."),e?u=e:(console.log("[IPC] Creating new WhatsAppManager (Fallback)"),u=new D(o)),t?w=t:(console.log("[IPC] Creating new MessageProcessor (Fallback)"),w=new F(u,o)),n?_=n:w&&(console.log("[IPC] Creating new QueueWorker (Fallback)"),_=new $(w)),c.ipcMain.handle("whatsapp:connect",async()=>{try{if(console.log("[IPC] whatsapp:connect called"),!u)throw new Error("WhatsAppManager not initialized");return{success:!0,connected:await u.connect()}}catch(s){return console.error("[IPC] whatsapp:connect error:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:disconnect",async()=>{try{if(console.log("[IPC] whatsapp:disconnect called"),!u)throw new Error("WhatsAppManager not initialized");return await u.disconnect(),{success:!0}}catch(s){return console.error("[IPC] whatsapp:disconnect error:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:send-message",async(s,{to:r,content:i,assets:a})=>{try{if(console.log(`[IPC] whatsapp:send-message called for ${r}`),!u)throw new Error("WhatsAppManager not initialized");let d;return a&&a.length>0?d=await u.sendMessageWithMedia(r,i,a[0]):d=await u.sendMessage(r,i),{success:d}}catch(d){return console.error("[IPC] whatsapp:send-message error:",d),{success:!1,error:d instanceof Error?d.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:get-status",async()=>{try{if(!u)return{status:"disconnected",ready:!1};const s=u.getStatus(),r=u.isReady();return{status:s,ready:r}}catch(s){return console.error("[IPC] whatsapp:get-status error:",s),{status:"disconnected",ready:!1}}}),c.ipcMain.handle("whatsapp:get-client-info",async()=>{try{return console.log("[IPC] whatsapp:get-client-info called"),u?await u.getClientInfo():null}catch(s){return console.error("[IPC] whatsapp:get-client-info error:",s),null}}),c.ipcMain.handle("whatsapp:process-job",async(s,{jobId:r,contacts:i,template:a,assets:d,delayConfig:h})=>{try{if(console.log(`[IPC] whatsapp:process-job called for job ${r}`),!u||!u.isReady())throw new Error("WhatsApp is not ready");if(_)console.log(`[IPC] Adding job ${r} to queue`),_.addToQueue({jobId:r,contacts:i,template:a,assets:d,delayConfig:h}).catch(p=>{console.error("[IPC] Error adding to queue:",p)});else if(w)console.warn("[IPC] QueueWorker not available, processing directly"),w.processJob({jobId:r,contacts:i,template:a,assets:d,delayConfig:h}).catch(p=>{console.error("[IPC] Job processing error:",p)});else throw new Error("MessageProcessor not initialized");return{success:!0,message:"Job started",jobId:r}}catch(p){return console.error("[IPC] whatsapp:process-job error:",p),{success:!1,error:p instanceof Error?p.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:pause-job",async(s,{jobId:r})=>{if(console.log(`[IPC] whatsapp:pause-job called for job ${r}`),w){const i=w.pause();return{success:i,message:i?"Job paused":"Failed to pause"}}return{success:!1,message:"Processor not ready"}}),c.ipcMain.handle("whatsapp:resume-job",async(s,{jobId:r})=>{if(console.log(`[IPC] whatsapp:resume-job called for job ${r}`),w){const i=w.resume();return{success:i,message:i?"Job resumed":"Failed to resume"}}return{success:!1,message:"Processor not ready"}}),console.log("[IPC] IPC handlers setup complete")};class Y{constructor(e,t){l(this,"whatsappManager");l(this,"mainWindow");l(this,"checkInterval",null);l(this,"CHECK_INTERVAL_MS",18e4);this.whatsappManager=e,this.mainWindow=t}startMonitoring(){this.checkInterval||(console.log("[StatusWorker] Starting status monitoring"),this.checkHealth(),this.checkInterval=setInterval(async()=>{await this.checkHealth()},this.CHECK_INTERVAL_MS))}stopMonitoring(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null,console.log("[StatusWorker] Stopped status monitoring"))}async checkHealth(){const e=this.whatsappManager.getStatus();if(console.log(`[StatusWorker] Health check: ${e}`),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:status-change",e),e==="disconnected"){console.log("[StatusWorker] Detected disconnection, attempting reconnect...");try{await this.whatsappManager.connect()}catch(t){console.error("[StatusWorker] Reconnect failed:",t)}}}}class K{constructor(e,t){l(this,"mainWindow");l(this,"unsubscribeKeywords",["unsubscribe","stop","batal","berhenti","jangan kirim","keluar","cancel"]);this.mainWindow=t}async handleIncomingMessage(e){try{console.log("[MessageReceiverWorker] Processing incoming message from:",e.from);const t=this.isUnsubscribeRequest(e.body);t&&(console.log("[MessageReceiverWorker] Unsubscribe request detected from:",e.from),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:unsubscribe-detected",{phoneNumber:e.from,message:e.body,timestamp:new Date().toISOString()})),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:message-received",{id:e.id._serialized,from:e.from,to:e.to,body:e.body,type:e.type,timestamp:e.timestamp,hasMedia:e.hasMedia,isUnsubscribeRequest:t})}catch(t){console.error("[MessageReceiverWorker] Error handling message:",t)}}isUnsubscribeRequest(e){if(!e)return!1;const t=e.toLowerCase();return this.unsubscribeKeywords.some(n=>t.includes(n))}}async function A(o){try{return await I.promises.access(o,I.constants.F_OK|I.constants.R_OK),!0}catch(e){return console.debug(`[Main] File does not exist or is not accessible: ${o}`,e),!1}}let g=null,M=null,k=null,v=null,C=null,S=null;const R=async()=>{let o;try{if(process.env.VITE_DEV_SERVER_URL){const e=m.join(__dirname,"../../public/icon.png");console.log("[Main] Development mode - trying icon path:",e),await A(e)?o=e:(console.warn("[Main] Development icon not found, falling back to default"),o=void 0)}else{const e=m.dirname(c.app.getAppPath()),t=m.join(e,"icon.ico");if(console.log("[Main] Production mode - trying icon path:",t),await A(t))o=t;else{const s=m.join(process.resourcesPath,"icon.ico");console.log("[Main] Fallback icon path:",s),o=await A(s)?s:void 0}}}catch(e){console.error("[Main] Error determining icon path:",e),o=void 0}try{if(g=new c.BrowserWindow({width:1200,height:800,autoHideMenuBar:!0,icon:o,webPreferences:{preload:m.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!0}}),process.platform==="win32"&&o)try{g.setIcon(o)}catch(e){console.error("[Main] Failed to set window icon:",e)}}catch(e){console.error("[Main] Failed to create browser window:",e),g=new c.BrowserWindow({width:1200,height:800,autoHideMenuBar:!0,webPreferences:{preload:m.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!0}})}if(console.log("[Main] Initializing workers..."),M=new D(g),k=new F(M,g),v=new $(k),C=new Y(M,g),S=new K(M,g),M.setMessageReceiverWorker(S),C.startMonitoring(),V(g,M,k,v),process.env.VITE_DEV_SERVER_URL)g.loadURL(process.env.VITE_DEV_SERVER_URL);else{const e=m.join(c.app.getAppPath(),"dist","index.html");console.log("[Main] Loading from:",e),g.loadFile(e)}g.webContents.on("before-input-event",(e,t)=>{(t.key==="F5"||t.control&&t.key==="r")&&e.preventDefault()}),g.webContents.on("did-fail-load",(e,t,n)=>{console.error("[Main] Failed to load:",t,n)}),g.webContents.on("crashed",(e,t)=>{console.error("[Main] Renderer crashed:",t)})};c.app.whenReady().then(async()=>{await R(),c.app.on("activate",()=>{c.BrowserWindow.getAllWindows().length===0&&R().catch(o=>{console.error("[Main] Error in activate handler:",o)})})});c.app.on("window-all-closed",()=>{C&&C.stopMonitoring(),M&&M.disconnect(),process.platform!=="darwin"&&c.app.quit()});
